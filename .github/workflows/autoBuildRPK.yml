name: Build RPK on Tag Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-rpk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x  # ‰∏•Ê†ºÂåπÈÖçÂõæÁâá‰∏≠ÁöÑ v20.19.2

      - name: Install dependencies
        run: |
          npm install
          # È™åËØÅÂ∑•ÂÖ∑ÈìæÂ≠òÂú®
          if [ ! -f "node_modules/.bin/aiot" ]; then
            echo "::error::aiot-toolkit not found in node_modules/.bin/"
            exit 1
          fi

      - name: Build RPK
        run: |
          # ‰ΩøÁî®Ê≠£Á°ÆÁöÑÊûÑÂª∫ÂëΩ‰ª§ÔºàÁßªÈô§ --release ÂèÇÊï∞Ôºâ
          ./node_modules/.bin/aiot build
          mv dist/*.rpk ./OK_School_Life-MiBand9Pro-${{ github.ref_name }}.rpk

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            LOGS=$(git log --pretty=format:"- %s ‚Ü≥ Êèê‰∫§‰∫∫: %an (%h)")
          else
            LOGS=$(git log --pretty=format:"- %s ‚Ü≥ Êèê‰∫§‰∫∫: %an (%h)" $PREV_TAG..${{ github.ref_name }})
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "üìù Êõ¥Êñ∞Êó•Âøó" >> $GITHUB_ENV
          echo "‰ªé ${PREV_TAG:-ÂàùÂßãÊèê‰∫§} Âà∞ ${{ github.ref_name }}" >> $GITHUB_ENV
          echo "$LOGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ${{ env.CHANGELOG }}

            üõ†Ô∏è ÊûÑÂª∫‰ø°ÊÅØ
            üïí ÊûÑÂª∫Êó∂Èó¥: ${{ steps.datetime.outputs.time }} (UTC+8)
            üè∑Ô∏è ÁâàÊú¨Ê†áÁ≠æ: ${{ github.ref_name }}
            üîó Êèê‰∫§È°µÈù¢: ${{ github.sha }}
          files: OK_School_Life-MiBand9Pro-${{ github.ref_name }}.rpk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get current time
        id: datetime
        run: echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT