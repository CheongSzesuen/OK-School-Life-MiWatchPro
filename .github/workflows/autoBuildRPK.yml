name: Signed RPK Release
on:
  push:
    tags:
      - 'v*'

jobs:
  build-rpk:
    runs-on: ubuntu-latest
    environment: production  # å…³è”ç¯å¢ƒï¼ˆå¦‚éœ€ç¯å¢ƒéš”ç¦»ï¼‰
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç 
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤2ï¼šè¿˜åŸç­¾åæ–‡ä»¶
      - name: Restore Signing Files
        run: |
          mkdir -p .temp_OkSchoolLife/sign/
          echo "${{ secrets.PRIVATE_PEM }}" > .temp_OkSchoolLife/sign/private.pem
          echo "${{ secrets.CERTIFICATE_PEM }}" > .temp_OkSchoolLife/sign/certificate.pem
          chmod 600 .temp_OkSchoolLife/sign/*.pem  # å…³é”®æƒé™è®¾ç½®[1,5](@ref)

      # æ­¥éª¤3ï¼šéªŒè¯ç­¾åæ–‡ä»¶
      - name: Verify Signing Files
        run: |
          ls -la .temp_OkSchoolLife/sign/
          openssl rsa -in .temp_OkSchoolLife/sign/private.pem -noout -check
          openssl x509 -in .temp_OkSchoolLife/sign/certificate.pem -noout -text

      # æ­¥éª¤4ï¼šè®¾ç½®Node.jsç¯å¢ƒ
      - uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: 'npm'

      # æ­¥éª¤5ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          npm install
          if [ ! -f "node_modules/.bin/aiot" ]; then
            echo "::error::aiot-toolkit not found"
            exit 1
          fi

      # æ­¥éª¤6ï¼šæ„å»ºå¹¶ç­¾åRPK
      - name: Build & Sign RPK
        run: |
          ./node_modules/.bin/aiot build --sign
          mv dist/*.rpk ./OK_School_Life-MiBand9Pro-${{ github.ref_name }}.rpk
        env:
          TEMP_PROJECT_PATH: ${{ github.workspace }}/.temp_OkSchoolLife  # æŒ‡å®šç­¾åè·¯å¾„[1](@ref)

      # æ­¥éª¤7ï¼šéªŒè¯RPKç­¾å
      - name: Verify RPK Signature
        run: |
          unzip -l OK_School_Life-*.rpk | grep META-INF/
          unzip -p OK_School_Life-*.rpk META-INF/CERT.RSA | openssl pkcs7 -inform DER -print_certs

      # æ­¥éª¤8ï¼šç”Ÿæˆæ›´æ–°æ—¥å¿—
      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            LOGS=$(git log --pretty=format:"- %s â†³ æäº¤äºº: %an (%h)")
          else
            LOGS=$(git log --pretty=format:"- %s â†³ æäº¤äºº: %an (%h)" $PREV_TAG..${{ github.ref_name }})
          fi
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "ğŸ“ ç­¾åç‰ˆæ›´æ–°æ—¥å¿—" >> $GITHUB_ENV
          echo "ç­¾åè¯ä¹¦æŒ‡çº¹: $(openssl x509 -in .temp_OkSchoolLife/sign/certificate.pem -noout -fingerprint)" >> $GITHUB_ENV
          echo "$LOGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # æ­¥éª¤9ï¼šåˆ›å»ºRelease
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: "ç­¾åç‰ˆ Release ${{ github.ref_name }}"
          body: |
            ${{ env.CHANGELOG }}

            ğŸ” ç­¾åéªŒè¯ä¿¡æ¯
            - ç­¾åæ–¹å¼: RSA-PKCS#1 v1.5
            - è¯ä¹¦æœ‰æ•ˆæœŸ: $(openssl x509 -in .temp_OkSchoolLife/sign/certificate.pem -noout -dates)
            - æ„å»ºæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S' -d @"${{ github.run_started_at }}") (UTC+8)
          files: OK_School_Life-MiBand9Pro-${{ github.ref_name }}.rpk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # æ­¥éª¤10ï¼šæ¸…ç†ç­¾åæ–‡ä»¶
      - name: Cleanup
        if: always()
        run: rm -rf .temp_OkSchoolLife/sign/