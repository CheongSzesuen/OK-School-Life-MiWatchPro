name: Build and Verify Signed RPK
on:
  push:
    tags:
      - 'v*'

jobs:
  build-rpk:
    runs-on: ubuntu-latest
    env:
      TEMP_SIGN_DIR: ${{ github.workspace }}/.temp_sign
      BUILD_OUTPUT: OK_School_Life-MiBand9Pro-${{ github.ref_name }}.rpk

    steps:
      # 1. ä»£ç æ£€å‡ºï¼ˆä¿ç•™å®Œæ•´gitå†å²ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–å¹¶éªŒè¯aiotå·¥å…·é“¾
      - name: Install dependencies
        run: |
          npm install
          if [ ! -f "node_modules/.bin/aiot" ]; then
            echo "::error::aiot-toolkit not found in node_modules/.bin/"
            exit 1
          fi

      # 4. å®‰å…¨å†™å…¥å¯†é’¥æ–‡ä»¶
      - name: Setup Signing Files
        run: |
          mkdir -p $TEMP_SIGN_DIR
          if [ -z "${{ secrets.PRIVATE_PEM }}" ] || [ -z "${{ secrets.CERTIFICATE_PEM }}" ]; then
            echo "::error::Missing PRIVATE_PEM or CERTIFICATE_PEM in secrets"
            exit 1
          fi
          echo "${{ secrets.PRIVATE_PEM }}" > $TEMP_SIGN_DIR/private.pem
          echo "${{ secrets.CERTIFICATE_PEM }}" > $TEMP_SIGN_DIR/certificate.pem
          if ! grep -q "BEGIN PRIVATE KEY" $TEMP_SIGN_DIR/private.pem || \
             ! grep -q "BEGIN CERTIFICATE" $TEMP_SIGN_DIR/certificate.pem; then
            echo "::error::Invalid PEM format"
            exit 1
          fi
          chmod 700 $TEMP_SIGN_DIR
          chmod 600 $TEMP_SIGN_DIR/*.pem

      # 5. å¯†é’¥å¯¹éªŒè¯ï¼ˆéé˜»å¡å¼ï¼‰
      - name: Validate Key Pair
        continue-on-error: true
        run: |
          openssl rsa -in $TEMP_SIGN_DIR/private.pem -noout -check
          if [ "$(openssl rsa -in $TEMP_SIGN_DIR/private.pem -noout -modulus | openssl sha256)" != \
               "$(openssl x509 -in $TEMP_SIGN_DIR/certificate.pem -noout -modulus | openssl sha256)" ]; then
            echo "::warning::Key pair mismatch (proceeding with unsigned build)"
          fi

      # 6. æ„å»ºRPKï¼ˆåŠ¨æ€ç”Ÿæˆç­¾åé…ç½®ï¼‰
      - name: Build RPK
        run: |
          # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
          cat > aiot.config.js <<EOF
          module.exports = {
            sign: {
              cert: '$TEMP_SIGN_DIR/certificate.pem',
              privateKey: '$TEMP_SIGN_DIR/private.pem'
            }
          }
          EOF
          
          # æ‰§è¡Œæ„å»º
          if grep -q "BEGIN PRIVATE KEY" $TEMP_SIGN_DIR/private.pem; then
            echo "::info::Building signed RPK package"
            ./node_modules/.bin/aiot build
          else
            echo "::warning::Building unsigned RPK due to invalid signing key"
            ./node_modules/.bin/aiot build
          fi
          
          # é‡å‘½åè¾“å‡ºæ–‡ä»¶
          mv dist/*.rpk $BUILD_OUTPUT

      # 7. æ–°å¢ç­¾åéªŒè¯æ­¥éª¤ [2,4](@ref)
      - name: Verify RPK Signature
        if: ${{ success() && secrets.PRIVATE_PEM }}
        run: |
          # è§£å‹RPKæ£€æŸ¥ç­¾åæ–‡ä»¶
          unzip -l $BUILD_OUTPUT | grep META-INF/CERT && echo "ç­¾åæ–‡ä»¶å­˜åœ¨" || exit 1
          
          # ä½¿ç”¨PythonéªŒè¯ç­¾åï¼ˆéœ€é¢„è£…pycryptodomeï¼‰
          python3 - <<EOF
          from Crypto.Signature import PKCS1_v1_5
          from Crypto.PublicKey import RSA
          from Crypto.Hash import SHA256
          import zipfile

          # æå–ç­¾åæ•°æ®
          with zipfile.ZipFile("$BUILD_OUTPUT") as z:
              with z.open('META-INF/CERT.SF') as f:
                  signature = f.read()
              with z.open('META-INF/MANIFEST.MF') as f:
                  manifest = f.read()

          # åŠ è½½å…¬é’¥
          with open("$TEMP_SIGN_DIR/certificate.pem", "rb") as f:
              pubkey = RSA.importKey(f.read())

          # éªŒè¯ç­¾å
          verifier = PKCS1_v1_5.new(pubkey)
          digest = SHA256.new(manifest)
          if verifier.verify(digest, signature):
              print("âœ… ç­¾åéªŒè¯é€šè¿‡")
          else:
              print("âŒ ç­¾åéªŒè¯å¤±è´¥")
              exit(1)
          EOF

      # 8. ç”Ÿæˆæ›´æ–°æ—¥å¿—
      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo "")
          LOGS=$(git log --pretty=format:"- %s (%h) by %an" ${PREV_TAG:+$PREV_TAG..}${{ github.ref_name }})
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "## ğŸ“ Changelog" >> $GITHUB_ENV
          echo "### ${PREV_TAG:-Initial commit} â†’ ${{ github.ref_name }}" >> $GITHUB_ENV
          echo "$LOGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 9. è·å–æ„å»ºæ—¶é—´ï¼ˆUTC+8ï¼‰
      - name: Get build time
        id: time
        run: |
          echo "time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      # 10. åˆ›å»ºGitHub Releaseï¼ˆå¢å¼ºå®‰å…¨æ ‡è¯†ï¼‰
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ${{ env.CHANGELOG }}

            ### Build Info
            - ğŸ•’ æ„å»ºæ—¶é—´: ${{ steps.time.outputs.time }} (UTC+8)
            - ğŸ·ï¸ æ ‡ç­¾: ${{ github.ref_name }}
            - ğŸ”— æäº¤: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - ğŸ” ç­¾åçŠ¶æ€: ${{ steps.verify-rpk.outcome == 'success' && 'Verified' || 'Unverified' }}
            - âš ï¸ å®‰å…¨æç¤º: ${{ !secrets.PRIVATE_PEM && 'æœªä½¿ç”¨ä»£ç ç­¾åè¯ä¹¦' || '' }}
          files: ${{ env.BUILD_OUTPUT }}