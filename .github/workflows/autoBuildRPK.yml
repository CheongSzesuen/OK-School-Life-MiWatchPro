name: Build RPK on Tag Release
# å·¥ä½œæµåç§°ï¼šåŸºäºæ ‡ç­¾å‘å¸ƒçš„RPKæ„å»ºæµç¨‹
# è§¦å‘æ¡ä»¶ï¼šå½“æ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼ˆå¦‚v1.0.0ï¼‰
on:
  push:
    tags:
      - 'v*'

jobs:
  build-rpk:
    # ä½¿ç”¨æœ€æ–°ç‰ˆUbuntuä½œä¸ºè¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»£ç ä»“åº“
      - name: Checkout code
        uses: actions/checkout@v4  # å®˜æ–¹æä¾›çš„ä»£ç æ£€å‡ºAction
        with:
          fetch-depth: 0  # è·å–å®Œæ•´gitå†å²è®°å½•ï¼Œç”¨äºç”Ÿæˆchangelog

      # æ­¥éª¤2ï¼šè®¾ç½®Node.jsç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v3  # å®˜æ–¹Node.jsç¯å¢ƒè®¾ç½®
        with:
          node-version: 20.x  # ä¸¥æ ¼åŒ¹é…å›¾ç‰‡ä¸­çš„v20.19.2ç‰ˆæœ¬
          cache: 'npm'  # å¯ç”¨npmç¼“å­˜åŠ é€Ÿå®‰è£…

      # æ­¥éª¤3ï¼šå®‰è£…é¡¹ç›®ä¾èµ–
      - name: Install dependencies
        run: |
          # å®‰è£…package.jsonä¸­çš„ä¾èµ–
          npm install
          
          # éªŒè¯aiotå·¥å…·é“¾æ˜¯å¦å­˜åœ¨ï¼ˆæ ¹æ®å›¾ç‰‡ç¡®è®¤éœ€è¦æ£€æŸ¥ï¼‰
          if [ ! -f "node_modules/.bin/aiot" ]; then
            echo "::error::aiot-toolkit not found in node_modules/.bin/"
            echo "è¯·ç¡®è®¤å·²é€šè¿‡AIoT IDEæ­£ç¡®å®‰è£…aiot-toolkit@2.0.3"
            exit 1
          fi

      # æ­¥éª¤4ï¼šæ„å»ºRPKåŒ…
      - name: Build RPK
        run: |
          # ä½¿ç”¨é¡¹ç›®æœ¬åœ°å®‰è£…çš„aiotå·¥å…·é“¾ï¼ˆå›¾ç‰‡æ˜¾ç¤ºå·²å®‰è£…2.0.3ç‰ˆæœ¬ï¼‰
          ./node_modules/.bin/aiot build
          
          # å°†ç”Ÿæˆçš„RPKæ–‡ä»¶æŒ‰çº¦å®šæ ¼å¼é‡å‘½å
          # æ ¼å¼ï¼šé¡¹ç›®åç§°-è®¾å¤‡ç±»å‹-æ ‡ç­¾ç‰ˆæœ¬.rpk
          mv dist/*.rpk ./OK_School_Life-MiBand9Pro-${{ github.ref_name }}.rpk

      # æ­¥éª¤5ï¼šç”Ÿæˆæ›´æ–°æ—¥å¿—
      - name: Generate changelog
        id: changelog  # å®šä¹‰æ­¥éª¤IDç”¨äºåç»­å¼•ç”¨
        run: |
          # è·å–å‰ä¸€ä¸ªæ ‡ç­¾ï¼ˆç”¨äºç”Ÿæˆç‰ˆæœ¬é—´å˜æ›´è®°å½•ï¼‰
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ github.ref_name }}^ 2>/dev/null || echo "")
          
          # æ ¹æ®æ˜¯å¦æœ‰å‰ä¸€ä¸ªæ ‡ç­¾ç”Ÿæˆä¸åŒçš„æ—¥å¿—èŒƒå›´
          if [ -z "$PREV_TAG" ]; then
            # é¦–æ¬¡å‘å¸ƒæ—¶è·å–å…¨éƒ¨æäº¤è®°å½•
            LOGS=$(git log --pretty=format:"- %s â†³ æäº¤äºº: %an (%h)")
          else
            # å¸¸è§„å‘å¸ƒè·å–ä¸¤ä¸ªæ ‡ç­¾ä¹‹é—´çš„æäº¤è®°å½•
            LOGS=$(git log --pretty=format:"- %s â†³ æäº¤äºº: %an (%h)" $PREV_TAG..${{ github.ref_name }})
          fi
          
          # å°†æ—¥å¿—å†…å®¹å†™å…¥ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CHANGELOG<<EOF" >> $GITHUB_ENV
          echo "ğŸ“ æ›´æ–°æ—¥å¿—" >> $GITHUB_ENV
          echo "ä» ${PREV_TAG:-åˆå§‹æäº¤} åˆ° ${{ github.ref_name }}" >> $GITHUB_ENV
          echo "$LOGS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # æ­¥éª¤6ï¼šè·å–å½“å‰æ—¶é—´ï¼ˆUTC+8æ—¶åŒºï¼‰
      - name: Get current time (Asia/Shanghai)
        id: datetime  # å®šä¹‰æ­¥éª¤IDç”¨äºåç»­å¼•ç”¨
        run: |
          # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼ˆUTC+8ï¼‰
          export TZ="Asia/Shanghai"
          # æ ¼å¼åŒ–æ—¶é—´ä¸ºYYYY-MM-DD HH:MM:SS
          echo "time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
        shell: bash  # æ˜ç¡®æŒ‡å®šshellç±»å‹

      # æ­¥éª¤7ï¼šåˆ›å»ºGitHub Release
      - name: Create Release
        uses: softprops/action-gh-release@v1  # ç¬¬ä¸‰æ–¹Releaseåˆ›å»ºå·¥å…·
        with:
          # ReleaseåŸºæœ¬ä¿¡æ¯è®¾ç½®
          tag_name: ${{ github.ref_name }}  # ä½¿ç”¨è§¦å‘å·¥ä½œæµçš„æ ‡ç­¾
          name: Release ${{ github.ref_name }}  # Releaseåç§°
          
          # Releaseæ­£æ–‡å†…å®¹ï¼ˆåŒ…å«æ›´æ–°æ—¥å¿—å’Œæ„å»ºä¿¡æ¯ï¼‰
          body: |
            ${{ env.CHANGELOG }}

            ğŸ› ï¸ æ„å»ºä¿¡æ¯
            ğŸ•’ æ„å»ºæ—¶é—´: ${{ steps.datetime.outputs.time }} (UTC+8)
            ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: ${{ github.ref_name }}
            ğŸ”— æäº¤é¡µé¢: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
          
          # è¦åŒ…å«çš„RPKæ–‡ä»¶
          files: OK_School_Life-MiBand9Pro-${{ github.ref_name }}.rpk
        env:
          # ä½¿ç”¨GitHubè‡ªåŠ¨ç”Ÿæˆçš„tokenè¿›è¡Œè®¤è¯
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}